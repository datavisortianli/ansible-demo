#!/usr/bin/env bash

# This script is for updating spark slaves list
# Usually, the list would locate in $SPARK_DIR/conf/slaves
# Please put it into cron job, like
# */5 * * * * /path/to/update_slaves.sh

AWK=$(which awk)
CURL=$(which curl)
SED=$(which sed)
GREP=$(which grep)
UNIQ=$(which uniq)
SORT=$(which sort)

SLAVES_TMP=/tmp/slaves
SLAVES_LIST_CONF={{ spark_conf_dir }}/conf/slaves

${CURL} -s "http://localhost:8080" | ${GREP} -E "worker-[0-9]{4}(0[1-9]|1[0-2])([0-3][1-9])" | ${SED} 's/<[^>]*>//g' | ${AWK} -F '-' '{print $3}' | ${UNIQ} | ${SORT} > ${SLAVES_TMP}

DIFF=$(diff ${SLAVES_TMP} ${SLAVES_LIST_CONF})
if [ "$DIFF" != "" ]
then
    cat ${SLAVES_TMP} > $SLAVES_LIST_CONF
fi
